# HAProxy Configuration for Staging Environment
# PostgreSQL Read/Write Splitting with Health Checks

global
    maxconn 1000
    log stdout format raw local0 info

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    retries 3

# ============================================
# Auth Database Cluster
# ============================================

# Write endpoint - Routes to Primary only
frontend auth_postgres_write
    bind *:5432
    default_backend auth_pg_primary

# Read endpoint - Load balance between Primary and Replica
frontend auth_postgres_read
    bind *:5433
    default_backend auth_pg_replicas

backend auth_pg_primary
    option pgsql-check user postgres
    server auth-primary auth-postgres-primary:5432 check inter 3s fall 3 rise 2

backend auth_pg_replicas
    balance roundrobin
    option pgsql-check user postgres
    server auth-primary auth-postgres-primary:5432 check inter 3s fall 3 rise 2 weight 1
    server auth-replica1 auth-postgres-replica1:5432 check inter 3s fall 3 rise 2 weight 2

# ============================================
# Main Database Cluster
# ============================================

# Write endpoint - Routes to Primary only
frontend main_postgres_write
    bind *:5434
    default_backend main_pg_primary

# Read endpoint - Load balance between Primary and Replica
frontend main_postgres_read
    bind *:5435
    default_backend main_pg_replicas

backend main_pg_primary
    option pgsql-check user postgres
    server main-primary main-postgres-primary:5432 check inter 3s fall 3 rise 2

backend main_pg_replicas
    balance roundrobin
    option pgsql-check user postgres
    server main-primary main-postgres-primary:5432 check inter 3s fall 3 rise 2 weight 1
    server main-replica1 main-postgres-replica1:5432 check inter 3s fall 3 rise 2 weight 2

# ============================================
# Stats Page
# ============================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:admin
