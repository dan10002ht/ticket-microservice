# HAProxy Configuration for Production Environment
# PostgreSQL Read/Write Splitting with Enhanced Health Checks

global
    maxconn 4000
    log stdout format raw local0 info
    # Security hardening
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option redispatch
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout check 5s
    retries 3

# ============================================
# Auth Database Cluster
# ============================================

# Write endpoint - Routes to Primary only
frontend auth_postgres_write
    bind *:5432
    default_backend auth_pg_primary

# Read endpoint - Load balance between Replicas (fallback to Primary)
frontend auth_postgres_read
    bind *:5433
    default_backend auth_pg_replicas

backend auth_pg_primary
    option pgsql-check user postgres
    default-server inter 3s fall 3 rise 2 slowstart 60s
    server auth-primary auth-postgres-primary:5432 check

backend auth_pg_replicas
    balance leastconn
    option pgsql-check user postgres
    default-server inter 3s fall 3 rise 2
    # Primary as fallback with lower weight
    server auth-primary auth-postgres-primary:5432 check weight 1 backup
    # Replicas with higher weight
    server auth-replica1 auth-postgres-replica1:5432 check weight 3
    server auth-replica2 auth-postgres-replica2:5432 check weight 3

# ============================================
# Main Database Cluster
# ============================================

# Write endpoint - Routes to Primary only
frontend main_postgres_write
    bind *:5434
    default_backend main_pg_primary

# Read endpoint - Load balance between Replicas (fallback to Primary)
frontend main_postgres_read
    bind *:5435
    default_backend main_pg_replicas

backend main_pg_primary
    option pgsql-check user postgres
    default-server inter 3s fall 3 rise 2 slowstart 60s
    server main-primary main-postgres-primary:5432 check

backend main_pg_replicas
    balance leastconn
    option pgsql-check user postgres
    default-server inter 3s fall 3 rise 2
    # Primary as fallback with lower weight
    server main-primary main-postgres-primary:5432 check weight 1 backup
    # Replicas with higher weight
    server main-replica1 main-postgres-replica1:5432 check weight 3
    server main-replica2 main-postgres-replica2:5432 check weight 3

# ============================================
# Stats Page (Protected)
# ============================================
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats auth ${HAPROXY_STATS_USER:-admin}:${HAPROXY_STATS_PASSWORD:-admin}
    stats admin if TRUE
    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
